---
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  return [
    { params: { locale: 'pt-br' } },
    { params: { locale: 'en-us' } },
  ];
}
---
<BaseLayout pageName="Portfolio">
    <canvas slot="main" id="canvas" class="w-full h-full"></canvas>
</BaseLayout>

<script>
    import * as THREE from 'three';
    import { STLLoader } from 'three/addons/loaders/STLLoader.js';
    import { OBJLoader } from 'three/examples/jsm/loaders/OBJLoader.js';
    import { MTLLoader } from 'three/examples/jsm/loaders/MTLLoader.js';
    import { Main } from '../../common/scene/main';
    import { Wall } from '../../common/scene/wall';
    import { degToRad } from 'three/src/math/MathUtils.js';

    const main = new Main();

    const materialLoader = new MTLLoader();
    const materials = await materialLoader.loadAsync('/model/obj/model.mtl');
    const loader = new OBJLoader();
    loader.setMaterials(materials);
    const group = await loader.loadAsync('/model/obj/model.obj');
    main.scene.add(group);

    group.scale.set(0.01, 0.01, 0.01);
    group.updateWorldMatrix(true, true);
    group.children.forEach((child) => {
        child.castShadow = true;
        child.receiveShadow = true;
    })

    const box = new THREE.Box3().setFromObject(group);

    const size = new THREE.Vector3();
    box.getSize(size);

    const center = new THREE.Vector3();
    box.getCenter(center);

    group.position.sub(center);
    box.setFromObject(group);
    box.getCenter(center)

    const walls = [
        new Wall(size.x, size.z, new THREE.Vector3(0,  1, 0), new THREE.Vector3(0, box.min.y, 0), new THREE.Vector3(0.2, 0.2, 0.2)),
        new Wall(size.x, size.z, new THREE.Vector3(0, -1, 0), new THREE.Vector3(0, box.max.y, 0), new THREE.Vector3(0.2, 0.2, 0.2)),

        new Wall(size.z, size.y, new THREE.Vector3( 1, 0, 0), new THREE.Vector3(box.min.x, 0, 0), new THREE.Vector3(0.075, 0.075, 0.075)),
        new Wall(size.z, size.y, new THREE.Vector3(-1, 0, 0), new THREE.Vector3(box.max.x, 0, 0), new THREE.Vector3(0.95, 0.95, 0.95)),

        new Wall(size.x, size.y, new THREE.Vector3(0, 0,  1), new THREE.Vector3(0, 0, box.min.z), new THREE.Vector3(0.95, 0.95, 0.95)),
        new Wall(size.x, size.y, new THREE.Vector3(0, 0, -1), new THREE.Vector3(0, 0, box.max.z), new THREE.Vector3(0.95, 0.95, 0.95)),
    ];

    walls.forEach((wall: Wall) => {
        wall.mesh.position.sub(center);
        main.scene.add(wall.mesh);
    });

    main.light.position.y = box.max.y;

    window.addEventListener("mousemove", () => {
        const direction = new THREE.Vector3();
        main.camera.getWorldDirection(direction);

        walls.forEach((wall: Wall) => {
            const sameOrientation = wall.normal.dot(direction) > 0.25;
            wall.mesh.visible = sameOrientation ? false : true;
        });
    })
</script>